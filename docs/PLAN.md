# pdftexter 実装プラン

## 📋 プロジェクト概要

Kindle電子書籍をPDF化し、DeepSeek-OCRを使用してPDFからテキスト（Markdown）に変換する統合ツールの開発プランです。

## 🎯 目標

1. **Kindle → PDF**: 既存機能の維持と改善
2. **PDF → Text**: DeepSeek-OCR（vLLM版）を使用した高精度OCR実装
3. **統合ワークフロー**: 一貫したCLI/GUIインターフェースの提供

## 📅 実装フェーズ

### フェーズ1: プロジェクト基盤構築 ⏳

#### 1.1 ディレクトリ構造の作成
- [x] プロジェクト構造ドキュメント作成（ARCHITECTURE.md）
- [x] 実装プランドキュメント作成（PLAN.md）
- [x] ディレクトリ構造の実装
  - `src/pdftexter/` 配下のモジュール構造
  - `tests/` テストディレクトリ
  - `scripts/` 実行スクリプト
  - `docs/` ドキュメント
  - `config/` 設定ファイル

#### 1.2 依存関係の整理
- [ ] `pyproject.toml` の更新
  - 既存依存関係の追加（pyautogui, Pillow, opencv-python, reportlab等）
  - 開発依存関係の追加（mypy, vulture, pydantic, pytest等）
  - Python 3.12+ の指定
- [ ] Poetry環境のセットアップ手順ドキュメント化

#### 1.3 既存コードのリファクタリング
- [ ] `kindle_screenshot.py` → `src/pdftexter/kindle/screenshot.py` に移行
- [ ] `kindle_pdf_convert.py` → `src/pdftexter/pdf/converter.py` に移行
- [ ] 共通機能の抽出（`utils/` モジュール）
- [ ] 型ヒントの追加
- [ ] ドキュメント文字列（docstring）の追加

### フェーズ2: DeepSeek-OCR統合 🔄

#### 2.1 DeepSeek-OCR環境のセットアップ
- [ ] DeepSeek-OCRリポジトリのクローン手順ドキュメント化
- [ ] vLLM環境のセットアップ手順
  - CUDA 11.8環境の確認
  - PyTorch 2.6.0のインストール
  - vLLM 0.8.5のインストール
  - flash-attn 2.7.3のインストール
- [ ] 動作確認用テストスクリプトの作成

#### 2.2 OCRモジュールの実装
- [ ] `src/pdftexter/ocr/config.py` の実装
  - YAML設定ファイルの読み込み
  - デフォルト設定の定義
  - 設定検証機能
- [ ] `src/pdftexter/ocr/vllm_wrapper.py` の実装
  - vLLMサーバーとの通信
  - リクエスト/レスポンス処理
  - エラーハンドリング
  - リトライ機能
  - タイムアウト処理
- [ ] `src/pdftexter/ocr/deepseek.py` の実装
  - DeepSeek-OCR統合インターフェース
  - PDFファイルのOCR処理
  - 画像ファイルのOCR処理
  - Markdown形式での出力
  - 進捗管理

#### 2.3 PDF処理モジュールの拡張
- [ ] `src/pdftexter/pdf/processor.py` の実装
  - PDFメタデータ取得
  - PDF検証機能
  - 必要に応じたページ分割

### フェーズ3: CLI/GUIインターフェース 🖥️

#### 3.1 CLI実装
- [ ] `src/pdftexter/cli/kindle_to_pdf.py` の実装
  - argparseによる引数解析
  - 既存機能のCLI化
  - エラーハンドリング
- [ ] `src/pdftexter/cli/pdf_to_text.py` の実装
  - PDF→Text変換のCLI
  - 出力形式選択（Markdown/Plain Text）
  - 進捗表示
- [ ] `src/pdftexter/cli/__main__.py` の実装
  - サブコマンド対応
  - 統合CLIインターフェース

#### 3.2 GUI改善（オプション）
- [ ] 既存GUIの改善
  - モダンなUIデザイン
  - 進捗表示の改善
  - エラーメッセージの改善
- [ ] 統合GUIの検討（Kindle→PDF→Textの一括処理）

### フェーズ4: テスト・品質管理 ✅

#### 4.1 ユニットテスト
- [ ] `tests/test_kindle/` のテスト作成
  - ウィンドウ検出のテスト
  - スクリーンショット機能のテスト
- [ ] `tests/test_pdf/` のテスト作成
  - PDF変換のテスト
  - PDF処理のテスト
- [ ] `tests/test_ocr/` のテスト作成
  - OCR設定のテスト
  - vLLMラッパーのテスト（モック使用）

#### 4.2 統合テスト
- [ ] Kindle→PDFの統合テスト
- [ ] PDF→Textの統合テスト
- [ ] エンドツーエンドテスト

#### 4.3 品質チェック
- [ ] mypyによる型チェック
- [ ] vultureによる未使用コード検出
- [ ] コードフォーマット（black, isort）
- [ ] リンター（ruff, flake8）

### フェーズ5: ドキュメント・デプロイ 📚

#### 5.1 ドキュメント整備
- [ ] README.mdの更新
  - プロジェクト概要
  - インストール手順
  - 使用方法
  - トラブルシューティング
- [ ] チュートリアルドキュメントの作成
  - 基本的な使用方法
  - 高度な使用方法
  - 設定のカスタマイズ

#### 5.2 デプロイ準備
- [ ] パッケージング設定
- [ ] インストールスクリプトの作成
- [ ] リリースノートの作成

## 🔧 技術的考慮事項

### DeepSeek-OCR統合の課題

#### 課題1: vLLM版の複雑さ
- **問題**: vLLM版の呼び出しが煩雑
- **解決策**: 
  - `vllm_wrapper.py`でラッパーを実装
  - 設定ファイルでパラメータを管理
  - シンプルなAPIインターフェースを提供

#### 課題2: 長文脈処理の最適化
- **問題**: 長いPDFの処理時間とメモリ使用量
- **解決策**:
  - ページ単位での処理
  - バッチ処理の実装
  - 進捗管理とキャンセル機能

#### 課題3: 画像抽出の精度
- **問題**: PDF内の画像が正しく抽出されない場合がある
- **解決策**:
  - 複数の画像抽出方法を試行
  - エラーハンドリングの強化
  - ログ出力によるデバッグ支援

### パフォーマンス最適化

1. **非同期処理**: OCR処理の非同期化
2. **キャッシュ**: 処理済みファイルのキャッシュ
3. **並列処理**: 複数ページの並列処理（可能な場合）

### エラーハンドリング

1. **堅牢なエラー処理**: 各モジュールでの適切なエラーハンドリング
2. **ログ機能**: 詳細なログ出力（loggingモジュール）
3. **ユーザーフレンドリーなエラーメッセージ**: 分かりやすいエラー表示

## 📝 実装の優先順位

### 高優先度（MVP）
1. ✅ プロジェクト構造の確立
2. ⏳ DeepSeek-OCR統合（vLLM版）
3. ⏳ PDF→Text変換の基本機能
4. ⏳ CLIインターフェース

### 中優先度
1. 既存コードのリファクタリング
2. テストの実装
3. ドキュメント整備

### 低優先度（将来の拡張）
1. GUI改善
2. 他のOCRエンジン対応
3. Web UI
4. クラウド統合

## 🚀 次のステップ

1. **依存関係の整理**: `pyproject.toml`の更新
2. **DeepSeek-OCR環境のセットアップ**: 動作確認
3. **OCRモジュールの実装**: 基本機能の実装開始

## 📌 注意事項

- **著作権**: すべての処理は個人利用の範囲内で行うこと
- **環境**: WSL2 + bash環境を前提とする
- **Python**: Python 3.12+ を使用
- **依存関係管理**: Poetryを使用
- **コード品質**: 型ヒント、docstring、テストを必須とする
